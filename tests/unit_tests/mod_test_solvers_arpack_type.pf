module mod_test_solvers_arpack_type
  use mod_suite_utils
  use funit
  use mod_arpack_type, only: arpack_t, new_arpack_config
  implicit none

  type(arpack_t) :: test_config

contains

  @test
  subroutine test_arpack_mode()
    call set_name("arpack type: set mode")
    test_config = new_arpack_config( &
      evpdim=10, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=2, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertEqual(2, test_config%iparam(7))
  end subroutine test_arpack_mode


  @test
  subroutine test_invalid_arpack_mode()
    call set_name("arpack type: set invalid mode")
    test_config = new_arpack_config( &
      evpdim=10, &
      mode=4, &
      bmat="G", &
      which="LM", &
      nev=2, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertExceptionRaised("Arnoldi: mode = 4 is invalid, expected 1, 2 or 3")
  end subroutine test_invalid_arpack_mode


  @test
  subroutine test_arpack_bmat()
    call set_name("arpack type: set bmat")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="I", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertEqual("I", test_config%get_bmat())
  end subroutine test_arpack_bmat


  @test
  subroutine test_arpack_bmat_invalid()
    call set_name("arpack type: set invalid bmat")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="M", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertExceptionRaised("Arnoldi: bmat = M is invalid, expected 'I' or 'G'")
  end subroutine test_arpack_bmat_invalid


  @test
  subroutine test_arpack_which()
    call set_name("arpack type: set which")
    test_config = new_arpack_config( &
      evpdim=10, &
      mode=2, &
      bmat="G", &
      which="LR", &
      nev=2, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertEqual("LR", test_config%get_which())
  end subroutine test_arpack_which


  @test
  subroutine test_arpack_invalid_which()
    character(125) :: msg
    call set_name("arpack type: set invalid which")
    test_config = new_arpack_config( &
      evpdim=10, &
      mode=2, &
      bmat="G", &
      which="LL", &
      nev=2, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    msg = "Arnoldi: which_eigenvalues = LL is invalid, " &
      // "expected one of [LM, SM, LR, SR, LI, SI]"
    @assertExceptionRaised(msg)
  end subroutine test_arpack_invalid_which


  @test
  subroutine test_arpack_nev()
    call set_name("arpack type: set nev")
    test_config = new_arpack_config( &
      evpdim=10, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=5, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertEqual(5, test_config%get_nev())
  end subroutine test_arpack_nev


  @test
  subroutine test_arpack_nev_negative()
    call set_name("arpack type: set negative nev")
    test_config = new_arpack_config( &
      evpdim=10, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=-3, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=7 &
    )
    @assertExceptionRaised("Arnoldi: number of eigenvalues must be >= 0 but got -3")
  end subroutine test_arpack_nev_negative


  @test
  subroutine test_arpack_nev_invalid()
    call set_name("arpack type: set invalid nev")
    test_config = new_arpack_config( &
      evpdim=10, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=12, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=7 &
    )
    @assertExceptionRaised("Arnoldi: number of eigenvalues (12) >= matrix size (10)")
  end subroutine test_arpack_nev_invalid


  @test
  subroutine test_arpack_default_ncv()
    call set_name("arpack type: set default ncv")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertEqual(20, test_config%get_ncv())
  end subroutine test_arpack_default_ncv


  @test
  subroutine test_arpack_ncv()
    call set_name("arpack type: set ncv")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=35 &
    )
    @assertEqual(35, test_config%get_ncv())
  end subroutine test_arpack_ncv


  @test
  subroutine test_arpack_invalid_ncv1()
    character(125) :: msg
    call set_name("arpack type: set invalid ncv (eq 1)")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=5 &
    )
    msg = "requesting too many eigenvalues, expected ncv - nev > 1 but got -5"
    @assertExceptionRaised(msg)
  end subroutine test_arpack_invalid_ncv1


  @test
  subroutine test_arpack_invalid_ncv2()
    character(125) :: msg
    call set_name("arpack type: set invalid ncv (eq 2)")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=120 &
    )
    msg = "ncv too high, expected ncv < N but got ncv = 120 and N = 100"
    @assertExceptionRaised(msg)
  end subroutine test_arpack_invalid_ncv2


  @test
  subroutine test_arpack_default_maxiter()
    call set_name("arpack type: set default maxiter")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=0, &
      ncv=0 &
    )
    @assertEqual(1000, test_config%iparam(3))
  end subroutine test_arpack_default_maxiter


  @test
  subroutine test_arpack_maxiter()
    call set_name("arpack type: set maxiter")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=5000, &
      ncv=0 &
    )
    @assertEqual(5000, test_config%iparam(3))
  end subroutine test_arpack_maxiter


  @test
  subroutine test_arpack_maxiter_negative()
    call set_name("arpack type: set negative maxiter")
    test_config = new_arpack_config( &
      evpdim=100, &
      mode=2, &
      bmat="G", &
      which="LM", &
      nev=10, &
      tolerance=1.0d-12, &
      maxiter=-1000, &
      ncv=0 &
    )
    @assertExceptionRaised("Arnoldi: maxiter must be positive, but is equal to -1000")
  end subroutine test_arpack_maxiter_negative

end module mod_test_solvers_arpack_type
